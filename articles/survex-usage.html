<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Package usage • survex</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- dalexverse --><link href="../dalexverse.css" rel="stylesheet">
<link href="../dalexverse-2.css" rel="stylesheet">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Package usage">
<meta property="og:description" content="survex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- google analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-5650686-14"></script><script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-5650686-14');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">survex</a>
        <div class="info">
          <span class="partof">part of the <a href="https://github.com/ModelOriented/DrWhy" class="external-link">DrWhy.AI</a>
           developed by the <a href="https://mi2.ai/" class="external-link">MI².AI</a> </span>
          <span class="version version-default">0.2.2.9000</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/mlr3proba-usage.html">How to use survex with mlr3proba</a>
    </li>
    <li>
      <a href="../articles/custom-explainers.html">Creating custom explainers</a>
    </li>
    <li>
      <a href="../articles/survex-usage.html">Package usage</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
        <li>
  <a href="https://github.com/ModelOriented/survex/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Package usage</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ModelOriented/survex/blob/HEAD/vignettes/survex-usage.Rmd" class="external-link"><code>vignettes/survex-usage.Rmd</code></a></small>
      <div class="hidden name"><code>survex-usage.Rmd</code></div>

    </div>

    
    
<p>This vignette summarizes the functionality of the <code>survex</code>
package by comparing two survival models. A Cox Proportional Hazards
model is analysed alongside a Random Survival Forest, showcasing the
functionality of the explanations and finding differences and
similarities between the two models.</p>
<div class="section level2">
<h2 id="model-and-explainer-creation">Model and explainer creation<a class="anchor" aria-label="anchor" href="#model-and-explainer-creation"></a>
</h2>
<p>For the purpose of this presentation, the <code>veteran</code>
dataset from the <code>survival</code> package will be used. The first
step is the creation of the models that will be used for making
predictions and their explainers.</p>
<p>It is important to note that for the <code><a href="../reference/explain_survival.html">explain()</a></code> function
to be able to extract the data automatically, we either have to set
certain parameters while creating the <code>coxph</code> model or
provide them manually. We chose to set the required parameters. The
creation of an explainer for the random survival forest doesn’t require
any additional steps.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://modeloriented.github.io/survex/">survex</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vet</span> <span class="op">&lt;-</span> <span class="fu">survival</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/survival/man/veteran.html" class="external-link">veteran</a></span></span>
<span></span>
<span><span class="va">cph</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">status</span><span class="op">)</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">vet</span>, model <span class="op">=</span> <span class="cn">TRUE</span>, x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">cph_exp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain_survival.html">explain</a></span><span class="op">(</span><span class="va">cph</span><span class="op">)</span></span>
<span><span class="co">#&gt; Preparation of a new explainer is initiated </span></span>
<span><span class="co">#&gt;   -&gt; model label       :  coxph ( <span style="color: #BBBB00;"> default </span> ) </span></span>
<span><span class="co">#&gt;   -&gt; data              :  137  rows  6  cols (  extracted from the model  ) </span></span>
<span><span class="co">#&gt;   -&gt; target variable   :  137  values ( 128 events and 9 censored ) (  extracted from the model  ) </span></span>
<span><span class="co">#&gt;   -&gt; times             :  94 unique time points , min = 1 , mean = 119.9706 , max = 845.56 </span></span>
<span><span class="co">#&gt;   -&gt; times             :  (  generated from y with method quantiles  ) </span></span>
<span><span class="co">#&gt;   -&gt; predict function  :  predict.coxph with type = 'risk' will be used ( <span style="color: #BBBB00;"> default </span> ) </span></span>
<span><span class="co">#&gt;   -&gt; predict survival function  :  predictSurvProb.coxph will be used ( <span style="color: #BBBB00;"> default </span> ) </span></span>
<span><span class="co">#&gt;   -&gt; predict cumulative hazard function  :  -log(predict_survival_function) will be used ( <span style="color: #BBBB00;"> default </span> ) </span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  package survival , ver. 3.4.0 , task survival ( <span style="color: #BBBB00;"> default </span> ) </span></span>
<span><span class="co">#&gt;   A new explainer has been created!</span></span>
<span></span>
<span><span class="va">rsf</span> <span class="op">&lt;-</span> <span class="fu">randomForestSRC</span><span class="fu">::</span><span class="fu"><a href="https://www.randomforestsrc.org//reference/rfsrc.html" class="external-link">rfsrc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">status</span><span class="op">)</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">vet</span><span class="op">)</span></span>
<span><span class="va">rsf_exp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain_survival.html">explain</a></span><span class="op">(</span><span class="va">rsf</span><span class="op">)</span></span>
<span><span class="co">#&gt; Preparation of a new explainer is initiated </span></span>
<span><span class="co">#&gt;   -&gt; model label       :  rfsrc ( <span style="color: #BBBB00;"> default </span> ) </span></span>
<span><span class="co">#&gt;   -&gt; data              :  137  rows  6  cols (  extracted from the model  ) </span></span>
<span><span class="co">#&gt;   -&gt; target variable   :  137  values ( 128 events and 9 censored ) (  extracted from the model  ) </span></span>
<span><span class="co">#&gt;   -&gt; times             :  94 unique time points , min = 1 , mean = 119.9706 , max = 845.56 </span></span>
<span><span class="co">#&gt;   -&gt; times             :  (  generated from y with method quantiles  ) </span></span>
<span><span class="co">#&gt;   -&gt; predict function  :  sum over the predict_cumulative_hazard_function will be used ( <span style="color: #BBBB00;"> default </span> ) </span></span>
<span><span class="co">#&gt;   -&gt; predict survival function  :  stepfun based on predict.rfsrc()$survival will be used ( <span style="color: #BBBB00;"> default </span> ) </span></span>
<span><span class="co">#&gt;   -&gt; predict cumulative hazard function  :  stepfun based on predict.rfsrc()$chf will be used ( <span style="color: #BBBB00;"> default </span> ) </span></span>
<span><span class="co">#&gt;   -&gt; model_info        :  package randomForestSRC , ver. 3.2.0 , task survival ( <span style="color: #BBBB00;"> default </span> ) </span></span>
<span><span class="co">#&gt;   A new explainer has been created!</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="making-predictions">Making predictions<a class="anchor" aria-label="anchor" href="#making-predictions"></a>
</h2>
<p>From this point onward, we operate only on the explainer objects
(<code>cph_exp</code> and <code>rsf_exp</code>) as they are the
standardized wrappers for the models. A useful feature of an explainer
is the ability to make predictions (of risk scores, as well as survival
and cumulative hazard functions) in a unified way independently of the
underlying model.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">cph_exp</span>, <span class="va">veteran</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="op">]</span>, output_type<span class="op">=</span><span class="st">"risk"</span><span class="op">)</span></span>
<span><span class="co">#&gt;         1         2 </span></span>
<span><span class="co">#&gt; 0.7354128 0.5942155</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">rsf_exp</span>, <span class="va">veteran</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="op">]</span>, output_type<span class="op">=</span><span class="st">"risk"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 59.97083 43.81380</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">cph_exp</span>, <span class="va">veteran</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="op">]</span>, output_type<span class="op">=</span><span class="st">"survival"</span>, times<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">600</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]      [,2]      [,3]      [,4]      [,5]      [,6]</span></span>
<span><span class="co">#&gt; [1,] 0.9959425 0.6869782 0.4288623 0.3064447 0.1871004 0.1302146</span></span>
<span><span class="co">#&gt; [2,] 0.9967203 0.7383282 0.5045589 0.3845663 0.2581276 0.1925939</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">rsf_exp</span>, <span class="va">veteran</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="op">]</span>, output_type<span class="op">=</span><span class="st">"survival"</span>, times<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">600</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]      [,2]      [,3]      [,4]      [,5]       [,6]</span></span>
<span><span class="co">#&gt; [1,] 0.9874942 0.6440157 0.3248874 0.1648385 0.0858866 0.05569097</span></span>
<span><span class="co">#&gt; [2,] 0.9908380 0.7835687 0.4285480 0.2619398 0.1496997 0.09270633</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">cph_exp</span>, <span class="va">veteran</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="op">]</span>, output_type<span class="op">=</span><span class="st">"chf"</span>, times<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">600</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;             [,1]      [,2]      [,3]      [,4]     [,5]     [,6]</span></span>
<span><span class="co">#&gt; [1,] 0.004065711 0.3754527 0.8466194 1.1827179 1.676110 2.038572</span></span>
<span><span class="co">#&gt; [2,] 0.003285105 0.3033668 0.6840708 0.9556392 1.354301 1.647171</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">rsf_exp</span>, <span class="va">veteran</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="op">]</span>, output_type<span class="op">=</span><span class="st">"chf"</span>, times<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">600</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;             [,1]      [,2]      [,3]     [,4]     [,5]     [,6]</span></span>
<span><span class="co">#&gt; [1,] 0.012505833 0.4781481 1.1520470 1.785237 2.312916 2.551416</span></span>
<span><span class="co">#&gt; [2,] 0.009161967 0.2501205 0.8693828 1.368775 1.908718 2.307685</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="measuring-performance">Measuring performance<a class="anchor" aria-label="anchor" href="#measuring-performance"></a>
</h2>
<p>Another helpful thing is the functionality for calculating different
metrics of the models. For this we use the
<code><a href="../reference/model_performance.surv_explainer.html">model_performance()</a></code> function. It calculates a set of
performance measures we can plot next to each other and easily
compare.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mp_cph</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_performance.surv_explainer.html">model_performance</a></span><span class="op">(</span><span class="va">cph_exp</span><span class="op">)</span></span>
<span><span class="va">mp_rsf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_performance.surv_explainer.html">model_performance</a></span><span class="op">(</span><span class="va">rsf_exp</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mp_cph</span>, <span class="va">mp_rsf</span><span class="op">)</span></span></code></pre></div>
<p><img src="survex-usage_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>We can also plot the scalar metrics in the form of bar plots.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mp_cph</span>, <span class="va">mp_rsf</span>, metrics_type<span class="op">=</span><span class="st">"scalar"</span><span class="op">)</span></span></code></pre></div>
<p><img src="survex-usage_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>From this comparison, we see that the Random Survival Forest model is
better in the Brier score metric (lower is better), Cumulative/Dynamic
AUC metric (higher is better), and their integrated versions, as well as
when we consider the concordance index. Therefore, it is a better
candidate for making predictions but lacks interpretability compared to
the Proportional Hazards model.</p>
</div>
<div class="section level2">
<h2 id="global-explanations">Global explanations<a class="anchor" aria-label="anchor" href="#global-explanations"></a>
</h2>
<div class="section level3">
<h3 id="variable-importance">Variable importance<a class="anchor" aria-label="anchor" href="#variable-importance"></a>
</h3>
<p>Next, we check how each variable influences the models’ predictions
on a global level. For this purpose, we use the
<code><a href="../reference/model_parts.surv_explainer.html">model_parts()</a></code> function. It calculates <a href="https://ema.drwhy.ai/featureImportance.html" class="external-link">permutational
variable importance</a> with the difference being that the loss function
is time-dependent (by default it is <code><a href="../reference/brier_score.html">loss_brier_score()</a></code>), so
the influence of each variable can be different at each considered time
point.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_parts_rsf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_parts.surv_explainer.html">model_parts</a></span><span class="op">(</span><span class="va">rsf_exp</span><span class="op">)</span></span>
<span><span class="va">model_parts_cph</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_parts.surv_explainer.html">model_parts</a></span><span class="op">(</span><span class="va">cph_exp</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model_parts_cph</span>,<span class="va">model_parts_rsf</span><span class="op">)</span></span></code></pre></div>
<p><img src="survex-usage_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>For both models, the permutation of the <code>karno</code> variable
leads to the highest increase in the loss function, with the second
being <code>celltype</code>. These two variables are the most important
for models making predictions.</p>
<p>We can use another loss function to ensure this observation is
consistent. Let’s use <code><a href="../reference/loss_one_minus_cd_auc.html">loss_one_minus_cd_auc()</a></code>, but let’s
also change the plot type to show the difference between the loss
function after a given variable’s permutation and the loss of the full
model with all variables. This means that the values on the y-axis
represent only the change in the loss function after permuting each
variable.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_parts_rsf_auc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_parts.surv_explainer.html">model_parts</a></span><span class="op">(</span><span class="va">rsf_exp</span>, loss_function<span class="op">=</span><span class="va">loss_one_minus_cd_auc</span>, type<span class="op">=</span><span class="st">"difference"</span><span class="op">)</span></span>
<span><span class="va">model_parts_cph_auc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_parts.surv_explainer.html">model_parts</a></span><span class="op">(</span><span class="va">cph_exp</span>, loss_function<span class="op">=</span><span class="va">loss_one_minus_cd_auc</span>, type<span class="op">=</span><span class="st">"difference"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># NOTE: this may take a long time, so a progress bar is available. To enable it, use:</span></span>
<span><span class="co"># progressr::with_progress(model_parts(rsf_exp, loss_function=loss_one_minus_cd_auc, type="difference"))</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model_parts_cph_auc</span>,<span class="va">model_parts_rsf_auc</span><span class="op">)</span></span></code></pre></div>
<p><img src="survex-usage_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>We observe that the results are consistent with
<code><a href="../reference/brier_score.html">loss_brier_score()</a></code>. That’s good news - a simple sanity
check that these variables are the most important for these models.</p>
</div>
<div class="section level3">
<h3 id="partial-dependence">Partial dependence<a class="anchor" aria-label="anchor" href="#partial-dependence"></a>
</h3>
<p>The next type of global explanation this package provides is partial
dependence plots. This is calculated using the
<code><a href="../reference/model_profile.surv_explainer.html">model_profile()</a></code> function. These plots show how setting one
variable to a different value would, on average, influence the model’s
prediction. Again, this is an extension of <a href="https://ema.drwhy.ai/partialDependenceProfiles.html" class="external-link">partial
dependence</a> known from regression and classification tasks, applied
to survival models by extending it to take the time dimension into
account.</p>
<p>Note that we need to set the <code>categorical_variables</code>
parameter in order to avoid nonsensical values, such as the treatment
value of 0.5. All factors are automatically detected as categories, but
if you want to treat a numerical variable as a categorical one, you need
to set it here.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_profile_cph</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_profile.surv_explainer.html">model_profile</a></span><span class="op">(</span><span class="va">cph_exp</span>, categorical_variables<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trt"</span>, <span class="st">"prior"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model_profile_cph</span>, facet_ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="survex-usage_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>From the plot, we see that for the proportional hazards model, the
<code>prior</code> and <code>diagtime</code> variables are not very
important. The plotted bands are very thin, almost overlapping, so the
overall prediction will be similar no matter what value these variables
take. On the other hand, the <code>karno</code> variable has a very wide
band which means that even a small change in its value causes a big
difference in the predicted survival function. We can also see that its
lower values indicate a lower chance of survival (survival function
decreases quicker).</p>
<p>We can also plot the same information for the random survival forest.
This time let’s change the way of plotting numerical variables, instead
of the values of the variables being represented by the colors and
survival function values on the y-axis, let’s swap them.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_profile_rsf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_profile.surv_explainer.html">model_profile</a></span><span class="op">(</span><span class="va">rsf_exp</span>, categorical_variables<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trt"</span>, <span class="st">"prior"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model_profile_rsf</span>, facet_ncol <span class="op">=</span> <span class="fl">1</span>, numerical_plot_type <span class="op">=</span> <span class="st">"contour"</span><span class="op">)</span></span></code></pre></div>
<p><img src="survex-usage_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>This type of plot also gives us valuable insight that is easy to
overlook in the other type. For example, we see a sharp drop in survival
function values around <code>diagtime=25</code>. We also observe that
the most significant influence of the <code>karno</code> variable is
consistent across the proportional hazards and random survival
forest.</p>
</div>
</div>
<div class="section level2">
<h2 id="local-explanations">Local explanations<a class="anchor" aria-label="anchor" href="#local-explanations"></a>
</h2>
<div class="section level3">
<h3 id="local-variable-attributions">Local variable attributions<a class="anchor" aria-label="anchor" href="#local-variable-attributions"></a>
</h3>
<p>Another kind of functionality provided by this package is local
explanations. The <code><a href="../reference/predict_parts.surv_explainer.html">predict_parts()</a></code> function can be used to
assess the importance of variables while making predictions for a
selected observation. This can be done by two methods, SurvSHAP(t) and
SurvLIME.</p>
<div class="section level4">
<h4 id="survshapt">SurvSHAP(t)<a class="anchor" aria-label="anchor" href="#survshapt"></a>
</h4>
<p><a href="https://www.sciencedirect.com/science/article/pii/S0950705122013302" class="external-link">SurvSHAP(t)</a>
explanations are an extension of SHAP values for survival models. They
show a breakdown of the prediction into individual variables.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predict_parts_cph_32</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_parts.surv_explainer.html">predict_parts</a></span><span class="op">(</span><span class="va">cph_exp</span>, <span class="va">veteran</span><span class="op">[</span><span class="fl">32</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">predict_parts_rsf_32</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_parts.surv_explainer.html">predict_parts</a></span><span class="op">(</span><span class="va">rsf_exp</span>, <span class="va">veteran</span><span class="op">[</span><span class="fl">32</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">predict_parts_cph_32</span>, <span class="va">predict_parts_rsf_32</span><span class="op">)</span></span></code></pre></div>
<p><img src="survex-usage_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predict_parts_cph_12</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_parts.surv_explainer.html">predict_parts</a></span><span class="op">(</span><span class="va">cph_exp</span>, <span class="va">veteran</span><span class="op">[</span><span class="fl">12</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">predict_parts_rsf_12</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_parts.surv_explainer.html">predict_parts</a></span><span class="op">(</span><span class="va">rsf_exp</span>, <span class="va">veteran</span><span class="op">[</span><span class="fl">12</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">predict_parts_cph_12</span>, <span class="va">predict_parts_rsf_12</span><span class="op">)</span></span></code></pre></div>
<p><img src="survex-usage_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<p>On the first plot, we see that for observation 32 from the
<code>veteran</code> data set, the value of <code>karno</code> variable
improves the chances of survival of this individual. In contrast, the
value of the <code>celltype</code> variable decreases them. This is true
for both explained models.</p>
<p>On the second plot, it can be seen, that for observation 12, the
situation is flipped, <code>celltype</code> increases the chances of
survival while <code>karno</code> decreases them. Interestingly, for the
random survival forest, one of the most influential variables is
<code>diagtime</code>, which the proportional hazards model almost
ignores.</p>
</div>
<div class="section level4">
<h4 id="survlime">SurvLIME<a class="anchor" aria-label="anchor" href="#survlime"></a>
</h4>
<p>A different way of attributing variable importance is provided by the
<a href="https://www.sciencedirect.com/science/article/pii/S0950705120304044?casa_token=3ikZP0SAYBQAAAAA:Tnez_adhQq0zubZQVPdg6EMZd9JCIfDTrLqekkfQoMBXgvzrmaSTl9fDFrey7fL4S21V7uxZ" class="external-link">SurvLIME</a>
method. It works by finding a surrogate proportional hazards model that
approximates the survival model at the local area around an observation
of interest. Variable importance is then attributed using the
coefficients of the found model.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predict_parts_cph_12_lime</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_parts.surv_explainer.html">predict_parts</a></span><span class="op">(</span><span class="va">cph_exp</span>, <span class="va">veteran</span><span class="op">[</span><span class="fl">12</span>,<span class="op">]</span>, type<span class="op">=</span><span class="st">"survlime"</span><span class="op">)</span></span>
<span><span class="va">predict_parts_rsf_12_lime</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_parts.surv_explainer.html">predict_parts</a></span><span class="op">(</span><span class="va">rsf_exp</span>, <span class="va">veteran</span><span class="op">[</span><span class="fl">12</span>,<span class="op">]</span>, type<span class="op">=</span><span class="st">"survlime"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">predict_parts_cph_12_lime</span>, type<span class="op">=</span><span class="st">"local_importance"</span><span class="op">)</span></span></code></pre></div>
<p><img src="survex-usage_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">predict_parts_rsf_12_lime</span>, type<span class="op">=</span><span class="st">"local_importance"</span><span class="op">)</span></span></code></pre></div>
<p><img src="survex-usage_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<p>The left part of the plot shows which variables are most important
and if their value increases or lowers the chances of survival, whereas
the right shows the black-box model prediction together with the one
from the found surrogate model. This is useful information because the
closer these functions are, the more accurate the explanation can
be.</p>
</div>
</div>
<div class="section level3">
<h3 id="ceteris-paribus">Ceteris paribus<a class="anchor" aria-label="anchor" href="#ceteris-paribus"></a>
</h3>
<p>Another explanation technique provided by this package is <a href="https://ema.drwhy.ai/ceterisParibus.html" class="external-link">ceteris paribus
profiles</a>. They show how the prediction changes when we change the
value of one variable at a time. We can think of them as the equivalent
of partial dependence plots but applied to a single observation. The
<code><a href="../reference/predict_profile.surv_explainer.html">predict_profile()</a></code> function is used to make these
explanations.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predict_profile_cph_32</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_profile.surv_explainer.html">predict_profile</a></span><span class="op">(</span><span class="va">cph_exp</span>, <span class="va">veteran</span><span class="op">[</span><span class="fl">32</span>,<span class="op">]</span>, categorical_variables<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trt"</span>, <span class="st">"prior"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">predict_profile_cph_32</span>, facet_ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="survex-usage_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predict_profile_rsf_32</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_profile.surv_explainer.html">predict_profile</a></span><span class="op">(</span><span class="va">rsf_exp</span>, <span class="va">veteran</span><span class="op">[</span><span class="fl">32</span>,<span class="op">]</span>, categorical_variables<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trt"</span>, <span class="st">"prior"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">predict_profile_rsf_32</span>, facet_ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="survex-usage_files/figure-html/unnamed-chunk-25-1.png" width="700"></p>
<p>These plots also give a lot of valuable insight. For example, we see
that the <code>prior</code> variable does not influence the predictions
very much, as the lines representing survival functions for its
different values almost overlap. We also observe that the
<code>celltype</code> values of <code>"small"</code> and
<code>"adeno"</code>, as well as <code>"large"</code> and
<code>"squamous"</code> result in almost the same prediction for this
observation. It can be seen that the most important variable for this
observation is <code>karno</code>, as the differences in the survival
function are the greatest, with low values indicating lower chances of
survival. In contrast, high values of the <code>diagtime</code> variable
seem to indicate lower chances of survival.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Mikołaj Spytek, Mateusz Krzyziński, Hubert Baniecki, Przemyslaw Biecek.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
